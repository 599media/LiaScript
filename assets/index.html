<!DOCTYPE html>
<html>
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script src='https://code.responsivevoice.org/responsivevoice.js'></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ext-language_tools.js"></script>

    <script type="text/javascript" src="js/vendor.js"></script>
    <script type="text/javascript" src="js/app.js"></script>

    <link rel="stylesheet" href="css/vendor.css">
    <link rel="stylesheet" href="css/app.css">

    <link href="https://fonts.googleapis.com/css?family=Roboto|Roboto+Mono" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" href="style.css">

    <!-- Favicons -->
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" href="/favicon.ico">

    <title>Lia Script</title>
  </head>
  <body>

    <script>
      //var Lia = require("src/index");
      //Elm.Main.embed(document.body, {url: "", script: ""});

      class LiaError extends Error {
          constructor(message, files,...params) {
              super(...params);
              if (Error.captureStackTrace)
                  Error.captureStackTrace(this, LiaError);
              this.message = message;
              this.details = [];
              for(var i=0; i<files; i++)
                  this.details.push([]);
          }
          add_detail(file_id, msg, type, line, column) {
              this.details[file_id].push(
                  { row : line,
                    column : column,
                    text : msg,
                    type : type } );
          }
      };

      function readTextFile(file) {
          var rawFile = new XMLHttpRequest();
          rawFile.open("GET", file, false);
          rawFile.onreadystatechange = function () {
              if(rawFile.readyState === 4) {
                  if(rawFile.status === 200 || rawFile.status == 0) {

                      const app = Elm.Main.embed(document.body, {url: "", script: "" }); //rawFile.responseText });

                      app.ports.speech_out.subscribe(function(cmd) {
                        try {
                          switch (cmd[0]) {
                            case "speak":
                              responsiveVoice.speak( cmd[2], cmd[1],
                                                     { onend: e => {
                                                         app.ports.speech_in.send(["end", ""]);
                                                       },
                                                       onerror: e => {
                                                         app.ports.speech_in.send(["error", e]);
                                                       }
                                                      } );
                              break;
                            case "cancel":
                              responsiveVoice.cancel()
                              break;
                            default:
                              console.log(cmd);
                          }
                        } catch (e) {
                          app.ports.speech_in.send(["error", e]);
                        }
                      });

                      app.ports.eval_tx.subscribe(function(cmd) {
                          var id = cmd[0];
                          var code = cmd[1];
                          try {
                              app.ports.eval_rx.send([true, id, String(eval(code))]);
                          }
                          catch (e) {
                                if (e instanceof LiaError ) {
                                    app.ports.eval_rx.send([false, id, e.message]);
                                } else {
                                    app.ports.eval_rx.send([false, id, e.message]);
                                }
                            }
                      });
                  }
              }
          }
          rawFile.send(null);
      }
      readTextFile("ReadMe.md")

    </script>
  </body>
</html>
